<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <style>
        #chat {
            width: 90%;
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }
        #usernameContainer {
            margin-bottom: 10px;
        }
        #username {
            width: 200px;
        }
                        #messageInput {
                                    width: 400px;
                        }
        /* Style for user's own messages */
        .my-message {
            color: #00008B; /* Dark Blue */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Chat Soba</h2>
            <div id="userCount">Korisnika online: 0</div>
    <!-- Username input section -->
    <div id="usernameContainer">
        <input type="text" id="username" placeholder="Napiši svoje ime" />
        <button onclick="setUsername()">Priključi se</button>
    </div>
    <!-- Chat display area -->
    <div id="chat"></div>
    <!-- Message input area -->
    <input type="text" id="messageInput" placeholder="Napiši poruku.." disabled />
    <button id="sendButton" onclick="sendMessage()" disabled>Pošalji/Enter</button>
            <p>* Chat poruke se spremaju 12 dana.<br>
            Možete se prijaviti pod bilo kojim imenom, no može se otkriti tko piše.<br></p>
    <script>
        let ws;
        let username = '';
        // Funkcija za prikazivanje input dijela za ime
        function showUsernameContainer() {
            document.getElementById('usernameContainer').style.display = 'block';
            document.getElementById('username').disabled = false;
            // opcionalno: da obrišete prethodni unos
            document.getElementById('username').value = '';
        }
        function setUsername() {
            const nameInput = document.getElementById('username');
            username = nameInput.value.trim();

            if (username === '') {

                alert('Napiši ime.');

                return;

            }

            // Sakrij dio za unos imena

            document.getElementById('usernameContainer').style.display = 'none';

 

            // Pokušaj konekcije na WebSocket
            connectWebSocket();
        }
        function connectWebSocket() {
            ws = new WebSocket('ws://192.168.1.106:8765');
            ws.onopen = () => {
                appendChatMessage('<em>Spojeni ste na chat kao ' + username + '</em>');
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('username').disabled = true;
            };
                                    ws.onmessage = (event) => {
                                               const message = event.data;
                                               console.log('Received message:', message);
                                               // Handle user count messages

                                               if (message.startsWith('USER_COUNT:')) {

                                                            const count = message.split(':')[1];

                                                           document.getElementById('userCount').innerText = 'Korisnika online: ' + count;

                                                           return; // exit to prevent displaying this as chat message

                                               }

 

                                               // Existing message handling

                                               if (message.startsWith(username + ':')) {

                                                           appendChatMessage('<span class="my-message">' + message + '</span>');

                                               } else {

                                                           appendChatMessage(message);

                                               }

                                    };

 

            ws.onerror = (error) => {

                alert('WebSocket error: ' + error);

            };

 

            ws.onclose = () => {
                appendChatMessage('<em>Odjavljeni ste sa chata</em>');
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
                // Pokaži ponovo deo za unos imena
                showUsernameContainer();
            };
        }
        function appendChatMessage(message) {
            const chatDiv = document.getElementById('chat');
            chatDiv.innerHTML += message + '<br>';
            chatDiv.scrollTop = chatDiv.scrollHeight; // auto-scroll
        }
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
           if (message === '') return;
            if (ws && ws.readyState === WebSocket.OPEN) {
                const fullMessage = username + ': ' + message;
                ws.send(fullMessage);
                // Prikaži lokalne poruke u tamno plavoj boji
                appendChatMessage('<span class="my-message">' + fullMessage + '</span>');
            }
            messageInput.value = '';
        }
        // Send message na Enter
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>